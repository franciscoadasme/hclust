require "./spec_helper"

private macro it_linkages(description, method, expected)
  it {{description}} do
    %dism = HClust::DistanceMatrix.new([
      0.00014170327, 0.92836676218, 0.93523316062, 0.94688524590, 0.95755968170,
      0.96718017415, 0.96718017415, 0.97437722420, 0.97297297297, 0.97616777884,
      0.98780487805, 0.99094011985, 0.98780487805, 0.92729970326, 0.99128751210,
      0.96433666191, 0.00000000000, 0.00000000000, 0.00173310225, 0.93438448199,
      0.94096883923, 0.95209741752, 0.96222912404, 0.97128918943, 0.97128918943,
      0.97800432371, 0.97669938608, 0.97966389172, 0.99027950107, 0.99305664659,
      0.99027950107, 0.93335972574, 0.99336065980, 0.96861990108, 0.00014170327,
      0.00014170327, 0.00088411054, 0.00018557834, 0.00147306121, 0.00402058173,
      0.00786094420, 0.00786094420, 0.01209148661, 0.01115155270, 0.01338428466,
      0.02547347823, 0.03052630312, 0.02547347823, 0.00000425123, 0.03116635277,
      0.00653998177, 0.92836676218, 0.92836676218, 0.94833468241, 0.00061326765,
      0.00248072456, 0.00563770827, 0.00563770827, 0.00929507864, 0.00847220277,
      0.01043431445, 0.02135726020, 0.02601394531, 0.02135726020, 0.00024599868,
      0.02660644333, 0.00452721131, 0.93523316062, 0.93523316062, 0.95419850756,
      0.00062790799, 0.00253686603, 0.00253686603, 0.00514555744, 0.00453699601,
      0.00600353186, 0.01478608557, 0.01871394362, 0.01478608557, 0.00163545264,
      0.01921889134, 0.00181099600, 0.94688524590, 0.94688524590, 0.96399238571,
      0.00064136616, 0.00064136616, 0.00218242918, 0.00179224317, 0.00275366460,
      0.00934851524, 0.01252909597, 0.00934851524, 0.00428574802, 0.01294419437,
      0.00030649659, 0.95755968170, 0.95755968170, 0.97274386404, 0.00000000000,
      0.00045812844, 0.00028963994, 0.00073811246, 0.00510512473, 0.00752235074,
      0.00510512473, 0.00822930352, 0.00784558336, 0.00006115080, 0.96718017415,
      0.96718017415, 0.98038216472, 0.00045812844, 0.00028963994, 0.00073811246,
      0.00510512473, 0.00752235074, 0.00510512473, 0.00822930352, 0.00784558336,
      0.00006115080, 0.96718017415, 0.96718017415, 0.98038216472, 0.00001923632,
      0.00003324637, 0.00250846281, 0.00427563472, 0.00250846281, 0.01254633199,
      0.00452057201, 0.00085388946, 0.97437722420, 0.97437722420, 0.98587737531,
      0.00010305825, 0.00296638102, 0.00486704991, 0.00296638102, 0.01158874008,
      0.00512807096, 0.00061687936, 0.97297297297, 0.97297297297, 0.98482364514,
      0.00196470506, 0.00355616909, 0.00196470506, 0.01386229078, 0.00377993332,
      0.00122390865, 0.97616777884, 0.97616777884, 0.98720577326, 0.00023497530,
      0.00000000000, 0.02612723457, 0.00029513848, 0.00628022685, 0.98780487805,
      0.98780487805, 0.99524453650, 0.00023497530, 0.03123969537, 0.00000342596,
      0.00893389141, 0.99094011985, 0.99094011985, 0.99712067374, 0.02612723457,
      0.00029513848, 0.00628022685, 0.98780487805, 0.98780487805, 0.99524453650,
      0.03188690139, 0.00687656887, 0.92729970326, 0.92729970326, 0.94741808906,
      0.00928558704, 0.99128751210, 0.99128751210, 0.99731562091, 0.96433666191,
      0.96433666191, 0.97815450570, 0.00000000000, 0.00173310225, 0.00173310225,
    ])
    {% precision = expected.map(&.[2].stringify.split(".").last.size).sort.first %}
    {% precision = 11 if precision > 11 %}
    {% if method.id =~ /\(.+\)/ %}
      {% method, extra_arguments = method.id.split("(") %}
      {% extra_arguments = extra_arguments.tr ")", "" %}
    {% else %}
      {% extra_arguments = nil %}
    {% end %}
    {{method.id}}(%dism, {{extra_arguments.id if extra_arguments}})
      .steps
      .map { |step| {step.nodes[0], step.nodes[1], step.distance.round({{precision}})} }
      .to_a
      .should eq {{expected}}
  end
end

describe HClust do
  describe "#mst" do
    it_linkages "clusters nodes using single linkage",
      HClust.mst,
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {18, 1, 0.00014170},
        {1, 19, 0.00088411},
        {19, 14, 0.92729970},
        {14, 2, 0.00000425},
        {2, 3, 0.00018558},
        {3, 4, 0.00061327},
        {4, 5, 0.00062791},
        {5, 16, 0.00030650},
        {16, 6, 0.00006115},
        {6, 7, 0.00000000},
        {7, 9, 0.00028964},
        {9, 8, 0.00001924},
        {8, 10, 0.00003325},
        {10, 11, 0.00196471},
        {11, 13, 0.00000000},
        {13, 12, 0.00023498},
        {12, 15, 0.00000343},
      ]
  end

  describe "#nn_chain" do
    it_linkages "clusters using the single linkage",
      HClust.nn_chain(:single, reuse: true),
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {1, 18, 0.00014170},
        {2, 14, 0.00000425},
        {3, 14, 0.00018558},
        {4, 14, 0.00061327},
        {6, 7, 0.00000000},
        {7, 16, 0.00006115},
        {8, 9, 0.00001924},
        {9, 10, 0.00003325},
        {10, 16, 0.00028964},
        {5, 16, 0.00030650},
        {11, 13, 0.00000000},
        {12, 15, 0.00000343},
        {13, 15, 0.00023498},
        {14, 16, 0.00062791},
        {15, 16, 0.00196471},
        {18, 19, 0.00088411},
        {16, 19, 0.92729970},
      ]

    it_linkages "clusters using the complete linkage",
      HClust.nn_chain(:complete, reuse: true),
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {1, 18, 0.00014170},
        {2, 14, 0.00000425},
        {3, 14, 0.00024600},
        {6, 7, 0.00000000},
        {7, 16, 0.00006115},
        {4, 5, 0.00062791},
        {8, 9, 0.00001924},
        {9, 10, 0.00010306},
        {10, 16, 0.00122391},
        {5, 14, 0.00428575},
        {11, 13, 0.00000000},
        {12, 15, 0.00000343},
        {13, 15, 0.00029514},
        {15, 16, 0.00928559},
        {14, 16, 0.03188690},
        {18, 19, 0.00173310},
        {16, 19, 0.99731562},
      ]

    it_linkages "clusters using the weighted linkage",
      HClust.nn_chain(:weighted, reuse: true),
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {1, 18, 0.00014170},
        {2, 14, 0.00000425},
        {3, 14, 0.00021579},
        {6, 7, 0.00000000},
        {7, 16, 0.00006115},
        {8, 9, 0.00001924},
        {5, 16, 0.00047393},
        {4, 14, 0.00108376},
        {9, 10, 0.00006815},
        {10, 16, 0.00156916},
        {11, 13, 0.00000000},
        {12, 15, 0.00000343},
        {13, 15, 0.00026506},
        {14, 16, 0.00569826},
        {15, 16, 0.01383877},
        {18, 19, 0.00130861},
        {16, 19, 0.97807528},
      ]

    it_linkages "clusters using the ward linkage",
      HClust.nn_chain(:ward, reuse: true),
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {1, 18, 0.00021255},
        {2, 14, 0.00000425},
        {3, 14, 0.00028630},
        {6, 7, 0.00000000},
        {7, 16, 0.00008153},
        {4, 5, 0.00062791},
        {8, 9, 0.00001924},
        {9, 10, 0.00008446},
        {10, 16, 0.00179620},
        {5, 14, 0.00531057},
        {11, 13, 0.00000000},
        {12, 15, 0.00000343},
        {13, 15, 0.00052840},
        {15, 16, 0.02347690},
        {14, 16, 0.07120330},
        {18, 19, 0.00239086},
        {16, 19, 7.23521293},
      ]

    it_linkages "clusters using the average linkage",
      HClust.nn_chain(:average, reuse: true),
      [
        {0, 17, 0.00000000},
        {17, 18, 0.00000000},
        {1, 18, 0.00014170},
        {2, 14, 0.00000425},
        {3, 14, 0.00021579},
        {6, 7, 0.00000000},
        {7, 16, 0.00006115},
        {8, 9, 0.00001924},
        {9, 10, 0.00006815},
        {5, 16, 0.00052974},
        {4, 14, 0.00124059},
        {10, 16, 0.00103290},
        {11, 13, 0.00000000},
        {12, 15, 0.00000343},
        {13, 15, 0.00026506},
        {15, 16, 0.00596833},
        {14, 16, 0.01338801},
        {18, 19, 0.00152085},
        {16, 19, 0.96840281},
      ]
  end
end
